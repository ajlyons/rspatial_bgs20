<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <meta name="author" content="Spatial Queries" />
  <meta name="copyright" content="<span class='footer-right'><a href='../acknowledgements.html'>Acknowledgements</a></span><span class='footer-right'><a href=' https://notes.typo3.org/p/rspatial-bgs20 ' target='_blank'>Forum</a></span><span class='footer-right'><a href=' https://ajlyons.github.io/rspatial_bgs20/ '> https://ajlyons.github.io/rspatial_bgs20/ </a></span><span class='footer-right'><a href='../index.html'>Home</a></span><span class='footer-subtitle'> Spatial Data Analysis with R </span>"/>
  <meta name="font-size-adjustment" content="2"/>
  <title>Spatial Data Analysis with R  BayGeo, Spring 2020</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAACkUlEQVQ4jX2SW0jTcRTHTzNyeZlh6lqmm3POdNPC6SxSEzaqafkykOFoIxTDWpKRFV6iQMNLFyMSsQvUW0WORc2WWBmGKEGZXUyz0NrmNmfa1PYgfHsQ1v5oHjgvX875/M45vy/R8mDJ9caxrFIL5CUWJB00Q9n+7Q+l1BetUMuMTL3JpTB0QVnejd1Hu9DQ60G5eQbqB7PIvj0L2bUZ0KZzghWbs0o7Fx3Tc/B6vStm6+g0wrQvIKh2gKKyUxnNSZoO685SC1YDeL1e9Ll+Ia7WCd5pJ4hojQ8g1nViezETYBqZx93BOdwa9jAgsdUT4J6ZQqC6f4GIiLYU9/RzNWYIdU9hd/8rLjN7UGT8DbWROVVMlQsBBWas142DiIikdfbFMF0POIVm2NzM1zwLS+mvcSsnEajpBSv/8RIgucGJ1EYXEs+NwjrlWfUGMee/Y2PFJIJLrFibex8kOsahhCYnUlpnIL1kh9X9/yMKG2yIOOlAsPYnAveZsE75EEQUQLwTwy5Rsxvx9UxApKEPEYY+BiSizA623oaggkdgq4xLKwRLq7i8sy6EFlpg8wNEVwyAd3wAbZ8cPu3CazeCC/sRojYjaL8Jvm8MPWLDBm03A8CveQ9+7RBia4cYU4QfeokwzTOwc6/4OzKXHap/C5ufD0RNo0i4OAZR81dcnnD69Mp3PxBe9GRkuZdFKk7sqTcQ132EpGUMydetSLnpgOSGHVtbxpHU9AX8mkFEG55/ZrjQL1h82V6esPLVh8Sr40i940J6xzzS7s1C0m6HqHEEiTnatgT5gcPijHxltFwhjpRIQpZjBAJ2lFTBFW5TiOPT8mXx6apdcRl5OaJM1Q6hLC9ls3RPTLgok0NELCKiv02kPqt/O1MZAAAAAElFTkSuQmCC" rel="icon" type="image/x-icon" />
  <script language="javascript" type="text/javascript">
  function TriShowHide(shID) {
    shIDspan = shID + "span";
    shIDdiv = shID + "div";
    if (document.getElementById(shIDdiv).style.display != 'block') {
      document.getElementById(shIDdiv).style.display = 'block';
      txtSpan = "&#9660;";
    } else {
      document.getElementById(shIDdiv).style.display = 'none';
      txtSpan = "&#9654;";
    }
    document.getElementById(shIDspan).innerHTML = txtSpan + " ";
  }
  function showHide(shID) {
    if (shID=="soln-show-all") {
      var allAnswerCode = document.getElementsByClassName("answer-code");
      for (i = 0; i < allAnswerCode.length; i++) {
          allAnswerCode[i].style.display = 'block';
      }
    } else if (shID=="soln-hide-all") {
      var allAnswerCode = document.getElementsByClassName("answer-code");
      for (i = 0; i < allAnswerCode.length; i++) {
          allAnswerCode[i].style.display = 'none';
      }
    } else if (shID=="hints-show-all") {
      var allAnswerCode = document.getElementsByClassName("hint");
      for (i = 0; i < allAnswerCode.length; i++) {
          allAnswerCode[i].style.display = 'block';
      }
    } else if (shID=="hints-hide-all") {
      var allAnswerCode = document.getElementsByClassName("hint");
      for (i = 0; i < allAnswerCode.length; i++) {
          allAnswerCode[i].style.display = 'none';
      }
    } else {
      if (document.getElementById(shID)) {
        if (document.getElementById(shID).style.display != 'block') {
          document.getElementById(shID).style.display = 'block';
        } else {
          document.getElementById(shID).style.display = 'none';
        }
      }
    }
  }
  function CopyToClipboard(containerid) {
  if (document.selection) {
      var range = document.body.createTextRange();
      range.moveToElementText(document.getElementById(containerid));
      range.select().createTextRange();
      document.execCommand("copy");
  } else if (window.getSelection) {
      var range = document.createRange();
      range.selectNode(document.getElementById(containerid));
      window.getSelection().addRange(range);
      document.execCommand("copy");
      // alert("text copied")
  }}
  </script>
  <link href="lib/slidy-2/styles/slidy.css" rel="stylesheet" />
  <script src="lib/slidy-2/scripts/slidy.js"></script>
  <script src="lib/slidy_shiny-1/slidy_shiny.js"></script>
  <script src="lib/clipboard-1.7.1/clipboard.min.js"></script>
  <link href="lib/primer-tooltips-1.4.0/build.css" rel="stylesheet" />
  <link href="lib/klippy-0.0.0.9500/css/klippy.min.css" rel="stylesheet" />
  <script src="lib/klippy-0.0.0.9500/js/klippy.min.js"></script>
  <script src="lib/kePrint-0.0.1/kePrint.js"></script>
  <link rel="stylesheet" type="text/css" media="screen, projection, print"
   href="..\css\slidy_styles.css" />
  <meta name="duration" content="0" />
</head>
<body>
<div class="slide titlepage">
  <h1 class="title"><span class="course-title">Spatial Data Analysis with R </span><br/><span class="course-subtitle">BayGeo, Spring 2020</span></h1>
  <p class="author">
Spatial Queries <br/><img src='images/spatial_query_410x310.png'/>
  </p>
</div>
<div id="spatial-queries" class="slide section level1">
<h1>Spatial Queries</h1>
<script language="javascript" type="text/javascript">w3c_slidy.mouse_click_enabled = false;</script>
<script>
  addKlippy('left', 'top', 'auto', '1', 'Copy code', 'Copied!');
</script>
<p>Spatial query = <strong>selecting</strong> features based on their <strong>location</strong> or <strong>spatial relationship</strong> (relative to another feature)</p>
<p><strong>aka <em>Spatial Subsetting</em></strong></p>
<p>Logical spatial relationship functions in <code>sf</code></p>
<table class="tbl_compact">
<tbody>
<tr>
<td style="text-align:left;font-family: monospace;">
st_intersects()
</td>
<td style="text-align:left;">
overlaps or touches
</td>
</tr>
<tr>
<td style="text-align:left;font-family: monospace;">
st_disjoint()
</td>
<td style="text-align:left;">
opposite of intersect
</td>
</tr>
<tr>
<td style="text-align:left;font-family: monospace;">
st_touches()
</td>
<td style="text-align:left;">
touches only
</td>
</tr>
<tr>
<td style="text-align:left;font-family: monospace;">
st_crosses()
</td>
<td style="text-align:left;">
cross (but doesn’t touch)
</td>
</tr>
<tr>
<td style="text-align:left;font-family: monospace;">
st_within()
</td>
<td style="text-align:left;">
within
</td>
</tr>
<tr>
<td style="text-align:left;font-family: monospace;">
st_contains()
</td>
<td style="text-align:left;">
contains
</td>
</tr>
<tr>
<td style="text-align:left;font-family: monospace;">
st_contains_properly()
</td>
<td style="text-align:left;">
interiors intersect but not edges or exterior
</td>
</tr>
<tr>
<td style="text-align:left;font-family: monospace;">
st_overlaps()
</td>
<td style="text-align:left;">
overlaps
</td>
</tr>
<tr>
<td style="text-align:left;font-family: monospace;">
st_equals()
</td>
<td style="text-align:left;">
equals
</td>
</tr>
<tr>
<td style="text-align:left;font-family: monospace;">
st_covers()
</td>
<td style="text-align:left;">
covers
</td>
</tr>
<tr>
<td style="text-align:left;font-family: monospace;">
st_covered_by()
</td>
<td style="text-align:left;">
completely covered
</td>
</tr>
<tr>
<td style="text-align:left;font-family: monospace;">
st_equals_exact()
</td>
<td style="text-align:left;">
equals within a tolerance
</td>
</tr>
<tr>
<td style="text-align:left;font-family: monospace;">
st_is_within_distance()
</td>
<td style="text-align:left;">
within a distance
</td>
</tr>
</tbody>
</table>
</div>
<div id="using-logical-spatial-relationship-functions" class="slide section level1">
<h1>Using logical spatial relationship functions</h1>
<p>Let’s look at an example:</p>
<div class="indented2" style="font-family:monospace;">
<strong>st_intersects(<em>x</em>, <em>y</em>, sparse=TRUE)</strong>
</div>
<p>where</p>
<div class="indented2">
<p><code>x</code> (target) and <code>y</code> (source) are both <code>sf</code> objects</p>
<p><code>sparse = TRUE</code> – return a <strong>list</strong> object (one element for each feature of x), where the elements are vectors integers (indices of y where the test is TRUE)</p>
<p><code>sparse = FALSE</code> – return a <strong>matrix of logical values</strong> (all pairs of features)</p>
</div>
<h3 id="example-find-all-the-points-of-interest-that-intersect-the-merced-hu-watershed.">Example: Find all the points of interest that intersect the Merced HU Watershed.</h3>
<p>Start by importing the watersheds:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r klippy copyme"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="co">## Import the watersheds, grouping by HUNAME</span></a>
<a class="sourceLine" id="cb1-2" title="2">gpkg_watershd_fn &lt;-<span class="st"> &quot;./data/yose_watersheds.gpkg&quot;</span></a>
<a class="sourceLine" id="cb1-3" title="3">yose_hu_watersheds &lt;-<span class="st"> </span><span class="kw">st_read</span>(gpkg_watershd_fn, <span class="dt">layer=</span><span class="st">&quot;calw221&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1-4" title="4"><span class="st">  </span><span class="kw">group_by</span>(HU) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb1-5" title="5"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">HUNAME =</span> <span class="kw">first</span>(HUNAME), <span class="dt">NUM_WATERSHEDS =</span> <span class="kw">n</span>())</a>
<a class="sourceLine" id="cb1-6" title="6"></a>
<a class="sourceLine" id="cb1-7" title="7"><span class="co">## Pull out just the merced water</span></a>
<a class="sourceLine" id="cb1-8" title="8">merced_watershed &lt;-<span class="st"> </span>yose_hu_watersheds <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">filter</span>(HUNAME <span class="op">==</span><span class="st"> &quot;MERCED RIVER&quot;</span>)</a>
<a class="sourceLine" id="cb1-9" title="9"></a>
<a class="sourceLine" id="cb1-10" title="10"><span class="co">## Plot boundaries</span></a>
<a class="sourceLine" id="cb1-11" title="11"><span class="kw">plot</span>(yose_hu_watersheds <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_geometry</span>())</a>
<a class="sourceLine" id="cb1-12" title="12"><span class="kw">plot</span>(merced_watershed <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_geometry</span>(), <span class="dt">add=</span><span class="ot">TRUE</span>, <span class="dt">col=</span><span class="st">&quot;lightpink&quot;</span>)</a></code></pre></div>
<pre><code>## Reading layer `calw221&#39; from data source `C:\Workshops\R-Spatial\rspatial_mod\outputs\rspatial_bgs20\docs\data\yose_watersheds.gpkg&#39; using driver `GPKG&#39;
## Simple feature collection with 127 features and 38 fields
## geometry type:  POLYGON
## dimension:      XY
## bbox:           xmin: 1383.82 ymin: -61442.93 xmax: 81596.71 ymax: 26405.66
## proj4string:    +proj=aea +lat_1=34 +lat_2=40.5 +lat_0=0 +lon_0=-120 +x_0=0 +y_0=-4000000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs</code></pre>
<p><img src="14_spatial-queries_files/figure-slidy/watershed_imp_klippy-1.png" width="768" /></p>
<p>Next import the points of interest:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r klippy copyme"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1"><span class="co">## Import points of interest</span></a>
<a class="sourceLine" id="cb3-2" title="2">yose_poi &lt;-<span class="st"> </span><span class="kw">st_read</span>(<span class="dt">dsn=</span><span class="st">&quot;./data&quot;</span>, <span class="dt">layer=</span><span class="st">&quot;yose_poi&quot;</span>) </a></code></pre></div>
<pre><code>## Reading layer `yose_poi&#39; from data source `C:\Workshops\R-Spatial\rspatial_mod\outputs\rspatial_bgs20\docs\data&#39; using driver `ESRI Shapefile&#39;
## Simple feature collection with 2720 features and 30 fields
## geometry type:  POINT
## dimension:      XY
## bbox:           xmin: 246416.2 ymin: 4153717 xmax: 301510.7 ymax: 4208419
## CRS:            26911</code></pre>
<p>Do the intersection:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r klippy copyme"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1">merced_poi &lt;-<span class="st"> </span>yose_poi <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_intersects</span>(merced_watershed)</a></code></pre></div>
<pre><code>## Error in st_geos_binop(&quot;intersects&quot;, x, y, sparse = sparse, prepared = prepared): st_crs(x) == st_crs(y) is not TRUE</code></pre>
<div class="indented2" style="color:red;font-weight:bold;">
Spatial querying requires features to be in the same crs!
</div>
<p>In this case, let’s project the HU watershed layer (which is in Albers) to match the points of interest (which are UTM):</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r klippy copyme"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1">yose_hu_utm &lt;-<span class="st"> </span>yose_hu_watersheds <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_transform</span>(<span class="kw">st_crs</span>(yose_poi))</a>
<a class="sourceLine" id="cb7-2" title="2">merced_hu_utm &lt;-<span class="st"> </span>yose_hu_utm <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">filter</span>(HUNAME <span class="op">==</span><span class="st"> &quot;MERCED RIVER&quot;</span>)</a></code></pre></div>
<div class="tip">
<p>Note the trick here. Rather than projecting the watersheds to a specific EPSG number, we project it to match whatever projection <code>yose_poi</code> is in. We don’t even need to know what it is!</p>
</div>
<!--- tip --->
<p>Try the intersection again:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r klippy copyme"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1">yose_poi_merced_yn &lt;-<span class="st"> </span>yose_poi <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_intersects</span>(merced_hu_utm, <span class="dt">sparse=</span><span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb8-2" title="2"><span class="kw">head</span>(yose_poi_merced_yn)</a>
<a class="sourceLine" id="cb8-3" title="3"></a>
<a class="sourceLine" id="cb8-4" title="4">merced_poi &lt;-<span class="st"> </span>yose_poi <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">slice</span>(<span class="kw">which</span>(yose_poi_merced_yn[,<span class="dv">1</span>]))</a></code></pre></div>
<pre><code>##      [,1]
## [1,] TRUE
## [2,] TRUE
## [3,] TRUE
## [4,] TRUE
## [5,] TRUE
## [6,] TRUE</code></pre>
<p>Plot to make sure:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r klippy copyme"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1"><span class="kw">plot</span>(yose_hu_utm  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_geometry</span>(), <span class="dt">border=</span><span class="st">&quot;gray70&quot;</span>)</a>
<a class="sourceLine" id="cb10-2" title="2"><span class="kw">plot</span>(merced_hu_utm <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_geometry</span>(), <span class="dt">add=</span><span class="ot">TRUE</span>, <span class="dt">col=</span><span class="st">&quot;lightpink&quot;</span>)</a>
<a class="sourceLine" id="cb10-3" title="3"><span class="kw">plot</span>(yose_poi <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_geometry</span>(), <span class="dt">col=</span><span class="st">&quot;gray30&quot;</span>, <span class="dt">pch=</span><span class="dv">16</span>, <span class="dt">cex=</span><span class="fl">0.3</span>, <span class="dt">add=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb10-4" title="4"><span class="kw">plot</span>(merced_poi <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_geometry</span>(), <span class="dt">col=</span><span class="st">&quot;darkgreen&quot;</span>, <span class="dt">pch=</span><span class="dv">16</span>, <span class="dt">cex=</span><span class="fl">0.8</span>, <span class="dt">add=</span><span class="ot">TRUE</span>)</a></code></pre></div>
<p><img src="14_spatial-queries_files/figure-slidy/watershed_poi_plot_klippy-1.png" width="768" /></p>
</div>
<div id="selecting-with-square-bracket-notation" class="slide section level1">
<h1>Selecting with Square Bracket Notation</h1>
<p>You can also subset spatially use the familiar square bracket notation, putting a sf object as the expression for the rows. The following are equivalent:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r sample_code"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1">poi_merced2 &lt;-<span class="st"> </span>yose_poi <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_intersection</span>(merced_hu_utm)</a>
<a class="sourceLine" id="cb11-2" title="2">poi_merced1 &lt;-<span class="st"> </span>yose_poi[merced_hu_utm, ]</a></code></pre></div>
<div class="infobox">
<p>By default, sf will do an intersection when the rows argument is a sf object. To use a different spatial test, add the op argument. E.g.,</p>
<div class="indented1 indented1-r">
<div class="sourceCode" id="cb12"><pre class="sourceCode r sample_code"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1"><span class="co"># poi_not_merced &lt;- yose_poi[merced_hu_utm, , op = st_disjoint]</span></a></code></pre></div>
</div>
</div>
<!--- info-box --->
<!---- # Example: Select features in a bounding box --->
</div>
<div id="example-generating-random-points" class="slide section level1">
<h1>Example: Generating Random Points</h1>
<p>In this example, we want to generate 500 random points. Because Yosemite is not rectangular, our approach will be to generate a whole bunch of random points within the bounding box (which is easy to do), filter out the ones that fall outside the boundary, and then randomly select 500 from the ones in the park.</p>
<p>First we import the boundary and generate 1500 points within the bounding box.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r klippy copyme"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1"><span class="co">## Import the yosemite border</span></a>
<a class="sourceLine" id="cb13-2" title="2">yose_bnd &lt;-<span class="st"> </span><span class="kw">st_read</span>(<span class="dt">dsn=</span><span class="st">&quot;./data&quot;</span>, <span class="dt">layer=</span><span class="st">&quot;yose_boundary&quot;</span>)</a></code></pre></div>
<pre><code>## Reading layer `yose_boundary&#39; from data source `C:\Workshops\R-Spatial\rspatial_mod\outputs\rspatial_bgs20\docs\data&#39; using driver `ESRI Shapefile&#39;
## Simple feature collection with 1 feature and 11 fields
## geometry type:  POLYGON
## dimension:      XY
## bbox:           xmin: -119.8864 ymin: 37.4947 xmax: -119.1964 ymax: 38.18515
## CRS:            4269</code></pre>
<div class="sourceCode" id="cb15"><pre class="sourceCode r klippy copyme"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" title="1">n &lt;-<span class="st"> </span><span class="dv">500</span></a>
<a class="sourceLine" id="cb15-2" title="2">yose_ext &lt;-<span class="st"> </span><span class="kw">st_bbox</span>(yose_bnd)</a>
<a class="sourceLine" id="cb15-3" title="3"></a>
<a class="sourceLine" id="cb15-4" title="4">xs &lt;-<span class="st"> </span><span class="kw">runif</span>(n<span class="op">*</span><span class="dv">3</span>, <span class="dt">min=</span>yose_ext[<span class="dv">1</span>], <span class="dt">max=</span>yose_ext[<span class="dv">3</span>])</a>
<a class="sourceLine" id="cb15-5" title="5">ys &lt;-<span class="st"> </span><span class="kw">runif</span>(n<span class="op">*</span><span class="dv">3</span>, <span class="dt">min=</span>yose_ext[<span class="dv">2</span>], <span class="dt">max=</span>yose_ext[<span class="dv">4</span>])</a>
<a class="sourceLine" id="cb15-6" title="6"></a>
<a class="sourceLine" id="cb15-7" title="7">rand_pts &lt;-<span class="st"> </span><span class="kw">st_as_sf</span>(<span class="kw">data.frame</span>(<span class="dt">lon=</span>xs, <span class="dt">lat=</span>ys), <span class="dt">coords=</span><span class="kw">c</span>(<span class="st">&quot;lon&quot;</span>, <span class="st">&quot;lat&quot;</span>), <span class="dt">crs=</span><span class="kw">st_crs</span>(yose_bnd))</a>
<a class="sourceLine" id="cb15-8" title="8"></a>
<a class="sourceLine" id="cb15-9" title="9"><span class="kw">plot</span>(rand_pts, <span class="dt">axes=</span>T, <span class="dt">pch=</span><span class="dv">16</span>, <span class="dt">cex=</span><span class="fl">0.5</span>)</a></code></pre></div>
<p><img src="14_spatial-queries_files/figure-slidy/rand_pts-1.png" width="768" /></p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r klippy copyme"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" title="1">in_yose_mat &lt;-<span class="st"> </span><span class="kw">st_within</span>(rand_pts, yose_bnd, <span class="dt">sparse=</span><span class="ot">FALSE</span>)</a></code></pre></div>
<pre><code>## although coordinates are longitude/latitude, st_within assumes that they are planar</code></pre>
<div class="sourceCode" id="cb18"><pre class="sourceCode r klippy copyme"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" title="1"><span class="kw">head</span>(in_yose_mat)</a></code></pre></div>
<pre><code>##      [,1]
## [1,] TRUE
## [2,] TRUE
## [3,] TRUE
## [4,] TRUE
## [5,] TRUE
## [6,] TRUE</code></pre>
<div class="sourceCode" id="cb20"><pre class="sourceCode r klippy copyme"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" title="1">pts_in_park &lt;-<span class="st"> </span>rand_pts[in_yose_mat[,<span class="dv">1</span>], ]</a>
<a class="sourceLine" id="cb20-2" title="2"><span class="kw">nrow</span>(pts_in_park)</a></code></pre></div>
<pre><code>## [1] 988</code></pre>
<div class="sourceCode" id="cb22"><pre class="sourceCode r klippy copyme"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" title="1"><span class="kw">plot</span>(pts_in_park, <span class="dt">axes=</span>T, <span class="dt">pch=</span><span class="dv">16</span>, <span class="dt">cex=</span><span class="fl">0.5</span>)</a></code></pre></div>
<p><img src="14_spatial-queries_files/figure-slidy/rand_pts-2.png" width="768" /></p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r klippy copyme"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" title="1">pts_in_park_sample &lt;-<span class="st"> </span>pts_in_park <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">sample_n</span>(n)</a>
<a class="sourceLine" id="cb23-2" title="2"><span class="kw">plot</span>(pts_in_park_sample, <span class="dt">axes=</span>T, <span class="dt">pch=</span><span class="dv">16</span>, <span class="dt">cex=</span><span class="fl">0.5</span>)</a></code></pre></div>
<p><img src="14_spatial-queries_files/figure-slidy/rand_pts-3.png" width="768" /></p>
</div>
<div id="distances-and-nearest-neighbors" class="slide section level1">
<h1>Distances and Nearest Neighbors</h1>
<p><tt>sf::st_distance()</tt> computes distances <strong>between all pairs of features</strong>. For example, if you wanted to compute the distance from every campground to every cell tower.</p>
To identify one or more nearest neighbors, use <tt><strong>st_nn()</strong></tt> from the <strong>nngeo</strong> package.
<div class="tip">
<p>When computing feature-to-feature distances or identifying nearest neighbors, the layers should be in the same CRS.</p>
</div>
<!--- tip --->
<h3 id="example-find-the-closest-trail-to-each-campground">Example: Find the closest trail to each campground</h3>
<div class="sourceCode" id="cb24"><pre class="sourceCode r klippy copyme"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" title="1"><span class="co">## Define a convenience variable for UTM Zone 11</span></a>
<a class="sourceLine" id="cb24-2" title="2">epsg_utm11n_nad83 &lt;-<span class="st"> </span><span class="dv">26911</span></a>
<a class="sourceLine" id="cb24-3" title="3"></a>
<a class="sourceLine" id="cb24-4" title="4"><span class="co">## Import the campgrounds</span></a>
<a class="sourceLine" id="cb24-5" title="5">yose_campgrnds_utm &lt;-<span class="st"> </span><span class="kw">st_read</span>(<span class="dt">dsn=</span><span class="st">&quot;./data&quot;</span>, <span class="dt">layer=</span><span class="st">&quot;yose_poi&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb24-6" title="6"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(POITYPE <span class="op">==</span><span class="st"> &#39;Campground&#39;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb24-7" title="7"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">select</span>(POINAME) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb24-8" title="8"><span class="st">  </span><span class="kw">st_transform</span>(epsg_utm11n_nad83)</a>
<a class="sourceLine" id="cb24-9" title="9"></a>
<a class="sourceLine" id="cb24-10" title="10"><span class="co">## Import the trails</span></a>
<a class="sourceLine" id="cb24-11" title="11">gdb_fn &lt;-<span class="st"> &quot;./data/yose_trails.gdb&quot;</span></a>
<a class="sourceLine" id="cb24-12" title="12"><span class="kw">file.exists</span>(gdb_fn)</a>
<a class="sourceLine" id="cb24-13" title="13">yose_trails_utm &lt;-<span class="st"> </span><span class="kw">st_read</span>(gdb_fn, <span class="dt">layer=</span><span class="st">&quot;Trails&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb24-14" title="14"><span class="st">  </span><span class="kw">st_transform</span>(epsg_utm11n_nad83)</a>
<a class="sourceLine" id="cb24-15" title="15"></a>
<a class="sourceLine" id="cb24-16" title="16"><span class="co">## Load the nngeo package</span></a>
<a class="sourceLine" id="cb24-17" title="17"><span class="kw">library</span>(nngeo)</a>
<a class="sourceLine" id="cb24-18" title="18"></a>
<a class="sourceLine" id="cb24-19" title="19">cp_closest_trail_idx &lt;-<span class="st"> </span><span class="kw">unlist</span>(<span class="kw">st_nn</span>(yose_campgrnds_utm, yose_trails_utm))</a>
<a class="sourceLine" id="cb24-20" title="20">cp_closest_trail_idx</a></code></pre></div>
<pre><code>## Reading layer `yose_poi&#39; from data source `C:\Workshops\R-Spatial\rspatial_mod\outputs\rspatial_bgs20\docs\data&#39; using driver `ESRI Shapefile&#39;
## Simple feature collection with 2720 features and 30 fields
## geometry type:  POINT
## dimension:      XY
## bbox:           xmin: 246416.2 ymin: 4153717 xmax: 301510.7 ymax: 4208419
## CRS:            26911</code></pre>
<pre><code>## [1] TRUE</code></pre>
<pre><code>## Reading layer `Trails&#39; from data source `C:\Workshops\R-Spatial\rspatial_mod\outputs\rspatial_bgs20\docs\data\yose_trails.gdb&#39; using driver `OpenFileGDB&#39;
## Simple feature collection with 1074 features and 13 fields
## geometry type:  MULTILINESTRING
## dimension:      XY
## bbox:           xmin: 245134 ymin: 4153668 xmax: 323239.7 ymax: 4250703
## CRS:            26911</code></pre>
<pre><code>## lines or polygons</code></pre>
<pre><code>##  [1] 610 117 275 467 504 961 237 432 343 563 541 603 566 927  72</code></pre>
<p>Plot the results:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r klippy copyme"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" title="1"><span class="co">## Plot results</span></a>
<a class="sourceLine" id="cb30-2" title="2">rainbow_cols &lt;-<span class="st"> </span><span class="kw">rainbow</span>(<span class="kw">nrow</span>(yose_campgrnds_utm), <span class="dt">end=</span><span class="dv">5</span><span class="op">/</span><span class="dv">6</span>)</a>
<a class="sourceLine" id="cb30-3" title="3"><span class="kw">tm_shape</span>(yose_trails_utm, <span class="dt">bbox=</span>yose_campgrnds_utm) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb30-4" title="4"><span class="st">  </span><span class="kw">tm_lines</span>(<span class="dt">col=</span><span class="st">&quot;gray90&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb30-5" title="5"><span class="st">  </span><span class="kw">tm_shape</span>(yose_trails_utm <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">slice</span>(cp_closest_trail_idx)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb30-6" title="6"><span class="st">  </span><span class="kw">tm_lines</span>(<span class="dt">col=</span><span class="st">&quot;red&quot;</span>, <span class="dt">lwd=</span><span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb30-7" title="7"><span class="st">  </span><span class="kw">tm_shape</span>(yose_campgrnds_utm) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb30-8" title="8"><span class="st">  </span><span class="kw">tm_symbols</span>(<span class="dt">col=</span><span class="st">&quot;POINAME&quot;</span>, <span class="dt">palette =</span> rainbow_cols, <span class="dt">size=</span><span class="fl">0.5</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb30-9" title="9"><span class="st">  </span><span class="kw">tm_layout</span>(<span class="dt">legend.show =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<pre><code>## Warning: Number of levels of the variable &quot;POINAME&quot; is 698, which is larger than max.categories (which
## is 30), so levels are combined. Set tmap_options(max.categories = 698) in the layer function to show all
## levels.</code></pre>
<p><img src="14_spatial-queries_files/figure-slidy/nngeo_plot_results_klippy-1.png" width="768" /></p>
</div>
<div id="summary" class="slide section level1">
<h1>Summary</h1>
<p>Today we saw how to:</p>
<div class="compact">
<ul>
<li>perform spatial queries with <tt>sf</tt></li>
</ul>
</div>
<div class="infobox">
<p>Additional Resources</p>
<div class="indented1">
<p><a href="https://geocompr.robinlovelace.net/spatial-operations.html" target="_blank">Geocomputation with R Ch4: Spatial Data Operations</a>. Robin Lovelace, Jakub Nowosad, Jannes Muenchow</p>
<p>2019-10-23</p>
</div>
</div>
<!--- additional resources --->
<p>
<strong>Next: </strong> <a href="15_branches_loops.html">Automation with Branches and Loops</a>
</p>
</div>

  <!-- dynamically load mathjax for compatibility with self-contained -->
  <script>
    (function () {
      var script = document.createElement("script");
      script.type = "text/javascript";
      script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
      document.getElementsByTagName("head")[0].appendChild(script);
    })();
  </script>

</body>
</html>
